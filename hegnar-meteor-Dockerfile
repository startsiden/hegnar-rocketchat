# FROM meteor/meteor-base:20211013T200759Z_489f5fe as METEOR_BUILD_IMAGE

# USER mt
# WORKDIR /home/mt

# # ENV NVM_DIR /home/mt/.nvm
# # ENV NODE_VERSION 14.21.3

# # # Install nvm with node and npm
# # RUN curl https://raw.githubusercontent.com/creationix/nvm/v0.39.0/install.sh | bash \
# #     && source $NVM_DIR/nvm.sh \
# #     && nvm install $NODE_VERSION \
# #     && nvm alias default $NODE_VERSION \
# #     && nvm use default \
# #     && npm install -g yarn@latest

# COPY --chown=mt . .

# RUN cd apps/meteor && yarn
# RUN cd apps/meteor && TOOL_NODE_FLAGS=--max-old-space-size=8192 && meteor build --server-only --directory /my-build


FROM meteor/ubuntu:20210720
SHELL ["/bin/bash", "-c"]

RUN useradd -ms /bin/bash mt
USER mt
WORKDIR /home/mt

RUN mkdir /home/mt/my-build

ENV NVM_DIR /home/mt/.nvm
# ENV NODE_VERSION 14.17.6
ENV NODE_VERSION 14.21.3
ENV NODE_PATH $NVM_DIR/v$NODE_VERSION/lib/node_modules
ENV PATH      $NVM_DIR/versions/node/v$NODE_VERSION/bin:/home/mt/.meteor:$PATH
ENV TOOL_NODE_FLAGS --max-old-space-size=8192

# Install nvm with node and npm
RUN curl https://raw.githubusercontent.com/creationix/nvm/v0.39.0/install.sh | bash \
    && source $NVM_DIR/nvm.sh \
    && nvm install $NODE_VERSION \
    && nvm alias default $NODE_VERSION \
    && nvm use default \
    && npm install -g meteor@latest \
    && npm install -g yarn@latest \
    && source $HOME/.bashrc

COPY --chown=mt . .

RUN cd apps/meteor && yarn
RUN cd apps/meteor && TOOL_NODE_FLAGS=--max-old-space-size=8192 && meteor build --server-only --directory /home/mt/my-build